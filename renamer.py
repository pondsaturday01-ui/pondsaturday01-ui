import os
import re

def natural_sort_key(s):
    """р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Кр╣Ир╕зр╕вр╣Ар╕гр╕╡р╕вр╕Зр╣Ар╕ер╕Вр╣Бр╕Ър╕Ър╕бр╕Щр╕╕р╕йр╕вр╣М (р╣Гр╕лр╣Й 2 р╕бр╕▓р╕Бр╣Ир╕нр╕Щ 10)"""
    return [int(text) if text.isdigit() else text.lower()
            for text in re.split('([0-9]+)', s)]

def batch_rename():
    print("--- ЁЯдЦ Smart Renamer V2: р╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕бр╕╖р╕нр╕Ир╕▒р╕Фр╕гр╕░р╣Ар╕Ър╕╡р╕вр╕Ър╕Лр╕╡р╕гр╕╡р╕кр╣М ---")
    folder_path = input("ЁЯУВ 1. р╣Гр╕кр╣Ир╕Кр╕╖р╣Ир╕нр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣М (р╣Ар╕Кр╣Ир╕Щ MyReels_Series): ").strip()
    
    if not os.path.exists(folder_path):
        print("тЭМ р╕лр╕▓р╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╣Др╕бр╣Ир╣Ар╕Ир╕нр╕Др╕гр╕▒р╕Ъ!")
        return

    # р╕Цр╕▓р╕бр╣Вр╕лр╕бр╕Фр╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕З
    print("\nЁЯФв 2. р╕Ир╕░р╣Гр╕лр╣Йр╣Ар╕гр╕╡р╕вр╕Зр╣Др╕Яр╕ер╣Мр╕вр╕▒р╕Зр╣Др╕Зр╕Фр╕╡р╕Др╕гр╕▒р╕Ъ?")
    print("   [A] р╣Ар╕гр╕╡р╕вр╕Зр╕Хр╕▓р╕бр╕Кр╕╖р╣Ир╕нр╣Др╕Яр╕ер╣М (р╣Ар╕лр╕бр╕▓р╕░р╕Бр╕▒р╕Ър╣Гр╕Кр╣Йр╕кр╕╣р╕Хр╕г Windows Rename р╕бр╕▓р╣Бр╕ер╣Йр╕з)")
    print("   [B] р╣Ар╕гр╕╡р╕вр╕Зр╕Хр╕▓р╕бр╣Ар╕зр╕ер╕▓р╕Чр╕╡р╣Ир╕кр╕гр╣Йр╕▓р╕З (р╣Ар╕лр╕бр╕▓р╕░р╕Бр╕▒р╕Ър╕Др╕Щр╕Чр╕╡р╣И Save р╕Зр╕▓р╕Щр╣Ар╕гр╕╡р╕вр╕Зр╕Бр╕▒р╕Щр╕бр╕▓)")
    mode = input("   ЁЯСЙ р╣Ар╕ер╕╖р╕нр╕Б (A/B): ").strip().upper()

    prefix = input("\nЁЯУЭ 3. р╕нр╕вр╕▓р╕Бр╣Гр╕лр╣Йр╕Кр╕╖р╣Ир╕нр╣Др╕Яр╕ер╣Мр╣Гр╕лр╕бр╣Ир╕Вр╕╢р╣Йр╕Щр╕Хр╣Йр╕Щр╕зр╣Ир╕▓р╕нр╕░р╣Др╕г? (р╣Ар╕Кр╣Ир╕Щ EP): ").strip()

    # р╕Фр╕╢р╕Зр╣Др╕Яр╕ер╣Мр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
    files = [f for f in os.listdir(folder_path) if f.lower().endswith(('.mp4', '.mov', '.avi'))]
    full_paths = [os.path.join(folder_path, f) for f in files]

    if mode == 'B':
        # р╕кр╕╣р╕Хр╕гр╣Вр╕Бр╕Зр╣Ар╕зр╕ер╕▓: р╣Ар╕гр╕╡р╕вр╕Зр╕Хр╕▓р╕бр╣Ар╕зр╕ер╕▓р╣Бр╕Бр╣Йр╣Др╕Вр╕ер╣Ир╕▓р╕кр╕╕р╕Ф (р╣Гр╕Др╕гр╕бр╕▓р╕Бр╣Ир╕нр╕Щ р╣Ар╕Ыр╣Зр╕Щр╕Юр╕╡р╣Ир╣Гр╕лр╕Нр╣И)
        full_paths.sort(key=os.path.getmtime)
        print("тП│ р╕Бр╕│р╕ер╕▒р╕Зр╣Ар╕гр╕╡р╕вр╕Зр╕Хр╕▓р╕б 'р╣Ар╕зр╕ер╕▓'...")
    else:
        # р╕кр╕╣р╕Хр╕гр╕Кр╕╖р╣Ир╕н: р╣Ар╕гр╕╡р╕вр╕Зр╕Хр╕▓р╕бр╕Кр╕╖р╣Ир╕нр╣Бр╕Ър╕Ър╕Йр╕ер╕▓р╕Ф (Natural Sort) р╣Бр╕Бр╣Йр╕Ыр╕▒р╕Нр╕лр╕▓ 1, 10, 2
        full_paths.sort(key=lambda x: natural_sort_key(os.path.basename(x)))
        print("ЁЯФд р╕Бр╕│р╕ер╕▒р╕Зр╣Ар╕гр╕╡р╕вр╕Зр╕Хр╕▓р╕б 'р╕Кр╕╖р╣Ир╕н'...")

    print(f"ЁЯзР р╣Ар╕Ир╕нр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф {len(files)} р╕Др╕ер╕┤р╕Ы... р╣Ар╕гр╕┤р╣Ир╕бр╕Ыр╕Пр╕┤р╕Ър╕▒р╕Хр╕┤р╕Бр╕▓р╕г!")

    count = 1
    for old_path in full_paths:
        old_name = os.path.basename(old_path)
        extension = os.path.splitext(old_name)[1]
        
        # р╕Хр╕▒р╣Йр╕Зр╕Кр╕╖р╣Ир╕нр╣Гр╕лр╕бр╣Ир╣Ар╕Ыр╣Зр╕Щ 001, 002 (р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕Ър╕нр╕Чр╕лр╕вр╕┤р╕Ър╕Цр╕╣р╕Бр╣Бр╕Щр╣Ир╕Щр╕нр╕Щ)
        new_name = f"{prefix}{str(count).zfill(3)}{extension}"
        new_path = os.path.join(folder_path, new_name)

        if old_path != new_path: # р╕Бр╕▒р╕Щр╕Юр╕ер╕▓р╕Фр╣Ар╕Ьр╕╖р╣Ир╕нр╕Кр╕╖р╣Ир╕нр╣Ар╕лр╕бр╕╖р╕нр╕Щр╣Ар╕Фр╕┤р╕б
            os.rename(old_path, new_path)
            print(f"тЬЕ [{count}] {old_name} ---> {new_name}")
        
        count += 1

    print("\nЁЯОЙ р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в! р╕Хр╕нр╕Щр╕Щр╕╡р╣Йр╕Др╕ер╕┤р╕Ыр╣Ар╕гр╕╡р╕вр╕Зр╣Ар╕Ыр╣Зр╕Щ EP001, EP002... р╕кр╕зр╕вр╕Зр╕▓р╕б р╕Юр╕гр╣Йр╕нр╕бр╣Гр╕лр╣Йр╕Ър╕нр╕Чр╕лр╕вр╕┤р╕Ър╣Бр╕ер╣Йр╕зр╕Др╕гр╕▒р╕Ъ!")

if __name__ == "__main__":
    batch_rename()